version: '3.3'
# 服务定义
services:
  certd:
    # 镜像源（优先阿里云，国内访问快；若失败可换 ghcr.io/certd/certd:latest）
    image: registry.cn-shenzhen.aliyuncs.com/handsfree/certd:latest
    container_name: certd
    # 重启策略：除非手动停止，否则异常重启
    restart: unless-stopped
    # 持久化存储：关联 Railway Volume，替代本地 /data/certd
    volumes:
      - certd-data:/app/data
    # 环境变量配置（核心，Railway 可直接覆盖）
    environment:
      # 时区（必配，避免证书时间错误）
      - TZ=Asia/Shanghai
      # 重置管理员密码（首次部署设为 true，登录后改回 false）
      - certd_system_resetAdminPasswd=true
      # 监听地址（必须 0.0.0.0，否则外部无法访问）
      - certd_koa_hostname=0.0.0.0
      # 监听端口（适配 Railway 自动分配的 PORT 环境变量）
      - certd_koa_port=${PORT:-7001}
    # 健康检查（Railway 自动检测服务是否正常）
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# 持久化存储卷（Railway 自动创建，关键！避免数据丢失）
volumes:
  certd-data:
    driver: local
